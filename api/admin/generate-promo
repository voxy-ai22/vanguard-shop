import jwt from "jsonwebtoken";
import { addPromo } from "../../utils/db.js";

export default function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ success: false, message: "Method not allowed" });
  }

  const { token, discount, type = "percentage" } = req.body || {};

  if (!token) {
    return res.status(401).json({ success: false, message: "Token required" });
  }

  // Cek token admin
  try {
    jwt.verify(token, process.env.JWT_SECRET);
  } catch (err) {
    return res.status(401).json({ success: false, message: "Invalid or expired token" });
  }

  // Validasi discount
  if (!discount || isNaN(discount) || discount < 1) {
    return res.status(400).json({
      success: false,
      message: "Valid discount amount is required"
    });
  }

  // Generate kode promo yang lebih unik
  const timestamp = Date.now().toString(36);
  const random = Math.random().toString(36).substring(2, 8);
  const code = `VG-${timestamp}-${random}`.toUpperCase();

  // Tambahkan promo ke database
  try {
    const result = addPromo(code, parseInt(discount), type);

    if (!result.success) {
      return res.status(400).json({
        success: false,
        message: result.message
      });
    }

    return res.status(200).json({
      success: true,
      message: "Promo generated successfully!",
      promo: result.promo
    });
  } catch (error) {
    console.error("Error generating promo:", error);
    return res.status(500).json({
      success: false,
      message: "Internal server error"
    });
  }
}
